<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartCloudPark Simulator — Neon</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#030118; --panel:#0b0720; --muted:#aeb8d4; --accent-cyan:#3bf0ff; --accent-pink:#ff48c4; --accent-purple:#6b3bff;
    --radius:12px; --glass:rgba(255,255,255,0.02);
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#06011a);color:#f6fbff}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:20px;font-family:Source Code Pro, monospace}
  .sub{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
  .card{background:var(--panel);padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.02);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .map{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:12px}
  .slot{border-radius:10px;padding:12px;text-align:center;min-height:86px;cursor:pointer;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03);transition:transform .18s}
  .slot.occ{background:linear-gradient(180deg,rgba(255,72,196,0.04),transparent)}
  .controls{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:8px;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-pink));color:#031018;font-weight:700;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
  .log{height:300px;overflow:auto;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;font-family:monospace;color:#d8f3e4}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
  input[type=number]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:90px}
  input[type=range]{width:100%}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} .map{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Simulator — Neon Dance Floor</h1>
        <div class="sub">Browser simulator — neon theme</div>
      </div>
      <div><span class="chip" id="statusChip">Stopped</span></div>
    </header>

    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Controls</div>
          <div class="sub">Uses anon key — safe for demo</div>
        </div>

        <div class="controls" style="margin-top:12px">
          <div class="row">
            <button class="btn" id="startBtn">Start</button>
            <button class="ghost" id="stopBtn">Stop</button>
            <button class="ghost" id="clearBtn">Clear Log</button>
          </div>

          <div class="row">
            <label style="min-width:90px;color:var(--muted)">Devices</label>
            <input id="deviceCount" type="number" min="1" max="100" value="10">
            <div class="sub" style="margin-left:8px">Number of virtual sensors</div>
          </div>

          <div class="row">
            <label style="min-width:90px;color:var(--muted)">Interval</label>
            <input id="intervalRange" type="range" min="500" max="8000" step="100" value="3000">
            <div style="width:70px;text-align:right;color:var(--muted)" id="intLbl">3.0 s</div>
          </div>

          <div class="row">
            <label style="min-width:90px;color:var(--muted)">Mode</label>
            <select id="modeSelect" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit">
              <option value="random">Random</option>
              <option value="sequential">Sequential</option>
              <option value="burst">Burst</option>
            </select>
          </div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

        <div style="font-weight:700">Preview</div>
        <div class="map" id="mapPreview"></div>
      </div>

      <div>
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Activity Log</div>
            <div class="sub">Events sent to Supabase</div>
          </div>
          <div class="log" id="log"></div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div class="sub">Events:</div><div id="count" class="chip">0</div>
            <a href="/" class="ghost" style="margin-left:auto">Open Dashboard</a>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:700">Quick</div>
          <div class="sub" style="margin-top:8px">Open Supabase or dashboard</div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="openTable" class="ghost">Supabase Table</button>
            <button id="openMain" class="ghost">Main Dashboard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* CONFIG (public anon key) */
const SUPABASE_URL = 'https://ipzpjtoyicberwrvdpgd.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwenBqdG95aWNiZXJ3cnZkcGdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyODE2NDgsImV4cCI6MjA3ODg1NzY0OH0.IRr_e6X8E49caJEIZGvHTZleLxMyxwXGkHyoDJjzWK4';
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const clearBtn = document.getElementById('clearBtn');
const logEl = document.getElementById('log');
const countEl = document.getElementById('count');
const statusChip = document.getElementById('statusChip');
const deviceCount = document.getElementById('deviceCount');
const intervalRange = document.getElementById('intervalRange');
const intLbl = document.getElementById('intLbl');
const modeSelect = document.getElementById('modeSelect');
const mapPreview = document.getElementById('mapPreview');

let running = false;
let timers = [];
let events = 0;
const TOTAL = 10;
intLbl.textContent = (intervalRange.value/1000).toFixed(1) + ' s';

function renderPreview(slots){
  mapPreview.innerHTML = '';
  for(let i=1;i<=TOTAL;i++){
    const s = (slots||[]).find(x=>x.slot_id===i) || {slot_id:i, occupied:false};
    const d = document.createElement('div');
    d.className = 'slot' + (s.occupied ? ' occ' : '');
    d.style.padding = '10px';
    d.style.borderRadius = '8px';
    d.innerHTML = `<div style="font-weight:700">#${i}</div><div style="margin-top:6px;color:var(--muted);font-size:12px">${s.occupied?'Occupied':'Free'}</div>`;
    d.onclick = ()=>manualToggle(i, s.occupied);
    mapPreview.appendChild(d);
  }
}

async function loadPreview(){
  const { data } = await supabase.from('parking_slots').select('*').order('slot_id', { ascending: true });
  renderPreview(data || []);
}

function log(t){
  const line = `[${new Date().toLocaleTimeString()}] ${t}`;
  if(!logEl.textContent.trim()) logEl.textContent = line + '\n';
  else logEl.textContent = line + '\n' + logEl.textContent;
  events++; countEl.textContent = events;
}

async function manualToggle(slotId, occupied){
  await supabase.from('parking_slots').update({ occupied: !occupied, last_updated: new Date().toISOString() }).eq('slot_id', slotId);
  await loadPreview();
  log(`Manual toggle ${slotId} -> ${!occupied ? 'occupied':'free'}`);
}

async function sendEvent(slotId, val){
  try{
    await supabase.from('parking_slots').update({ occupied: val, last_updated: new Date().toISOString() }).eq('slot_id', slotId);
    await loadPreview();
    log(`Simulated ${slotId} -> ${val ? 'occupied':'free'}`);
  }catch(e){ log('error sending'); console.error(e); }
}

function startSim(){
  if(running) return;
  running = true; statusChip.textContent = 'Running';
  const count = Math.max(1, parseInt(deviceCount.value||10,10));
  const interval = Math.max(500, parseInt(intervalRange.value,10)||3000);
  const mode = modeSelect.value;

  if(mode==='random'){
    for(let i=0;i<count;i++){
      const id = setInterval(()=>{
        const slot = Math.floor(Math.random()*TOTAL)+1;
        const val = Math.random()>0.5;
        sendEvent(slot, val);
      }, interval + Math.floor(Math.random()*900));
      timers.push(id);
    }
  } else if(mode==='sequential'){
    let cur=1;
    const id = setInterval(()=>{
      const val = Math.random()>0.5;
      sendEvent(cur, val);
      cur++; if(cur>TOTAL) cur=1;
    }, interval);
    timers.push(id);
  } else {
    const id = setInterval(()=>{
      const burst = Math.max(1, Math.floor(Math.random()*4));
      for(let j=0;j<burst;j++){
        const slot = Math.floor(Math.random()*TOTAL)+1;
        const val = Math.random()>0.5;
        sendEvent(slot,val);
      }
    }, interval);
    timers.push(id);
  }
}

function stopSim(){ timers.forEach(t=>clearInterval(t)); timers=[]; running=false; statusChip.textContent='Stopped'; }

startBtn.onclick = ()=>{ startSim(); }
stopBtn.onclick = ()=>{ stopSim(); }
clearBtn.onclick = ()=>{ logEl.textContent=''; events=0; countEl.textContent='0'; }
intervalRange.oninput = ()=>{ intLbl.textContent = (intervalRange.value/1000).toFixed(1) + ' s'; }

document.getElementById('openTable').onclick = ()=>{ window.open(`${SUPABASE_URL}/project/_/table/parking_slots`); }
document.getElementById('openMain').onclick = ()=>{ window.open(`/`); }

supabase
  .channel('public:parking_slots')
  .on('postgres_changes',{event:'*',schema:'public',table:'parking_slots'}, payload =>{
    loadPreview();
  })
  .subscribe();

loadPreview();
</script>
</body>
</html>

